<!DOCTYPE html>
<html>
  *
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <title>ProofJS Demos</title>
    <link
      rel="stylesheet"
      href="./proof.css"
      type="text/css"
      media="screen"
      title="no title"
      charset="utf-8"
    />
    <link
      rel="stylesheet"
      href="./demo.css"
      type="text/css"
      media="screen"
      title="no title"
      charset="utf-8"
    />
    <script src="./proof.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css"
      type="text/css"
      media="screen"
      title="no title"
      charset="utf-8"
    />
  </head>
  <body>
    <div>
      <p>Press <code>Enter</code> to create a new sibling node.</p>
      <p>Press <code>Ctrl-Enter</code> to create a new parent node.</p>
      <p>Press <code>Ctrl-Shift-Enter</code> to create a new child node.</p>
      <p>Cycle nodes with <code>Tab</code> and <code>Shift-Tab</code>.</p>
      <p>
        Undo and Redo changes with <code>Ctrl-Z</code> and
        <code>Ctrl-Shift-Z</code>.
      </p>
      <p>Delete subtrees with <code>Ctrl-Backspace</code>.</p>
      <p>
        Cut, Copy, and Paste subtrees with <code>Shift-Ctrl-X</code>,
        <code>Shift-Ctrl-C</code> and <code>Shift-Ctrl-V</code>
      </p>
      <p>
        Mouse over rule labels for annotations, including errors and calculated
        sequents for the Gentzen-Prawitz tree.
      </p>
    </div>
    <div style="margin-bottom: 10px; display: flex; flex-wrap: wrap">
      <div id="sandbox1" class="sandbox">
        <div class="json-container">
          view JSON
          <div id="json1" class="json"></div>
        </div>
      </div>
      <div id="sandbox2" class="sandbox">
        <div class="json-container">
          view JSON
          <div id="json2" class="json"></div>
        </div>
      </div>
      <div id="sandbox3" class="sandbox">
        <div class="json-container">
          view JSON
          <div id="json3" class="json"></div>
        </div>
      </div>
    </div>
  </body>
  <script id="alljs" src="./all.js"></script>
  <script defer>
    var sandbox1 = document.getElementById("sandbox1");
    var sandbox2 = document.getElementById("sandbox2");
    var sandbox3 = document.getElementById("sandbox3");

    var jsonDisplay1 = document.getElementById("json1");
    var jsonDisplay2 = document.getElementById("json2");
    var jsonDisplay3 = document.getElementById("json3");

    var root1 = new DeductionRoot({
      label: "Pa,~Qb,Pa->Qb:|-:",
      rule: "->",
      ident: 0,
      forest: [
        {
          label: "Pa,~Qb,~Pa:|-:",
          rule: "St",
          ident: 1,
          forest: [
            {
              label: "~Qb,Pa,~Pa:|-:",
              rule: "Ax",
              ident: 2,
              forest: [
                {
                  label: "",
                  rule: "",
                  ident: 15,
                  forest: [],
                },
              ],
            },
          ],
        },
        {
          label: "Pa,~Qb,Qb:|-:",
          rule: "Ax",
          ident: 3,
          forest: [
            {
              label: "",
              rule: "",
              ident: 4,
              forest: [],
            },
          ],
        },
      ],
    });

    var root2 = new DeductionRoot({
      label: "Ax(Px&Qx):|-:",
      rule: "A",
      ident: 11,
      forest: [
        {
          label: "Ax(Px&Qx),Pa&Qa:|-:",
          rule: "&",
          ident: 41,
          forest: [
            {
              label: "Ax(Px&Qx),Pa,Qa:|-:",
              rule: "Lit",
              ident: 43,
              forest: [
                {
                  label: "",
                  rule: "",
                  ident: 20,
                  forest: [],
                },
              ],
            },
          ],
        },
      ],
    });
    var root3 = new DeductionRoot({
      label: "Pc,~Qa,Pc->Qa:|-:",
      rule: "->",
      forest: [
        {
          label: "Pc,~Qa,~Pc:|-:",
          rule: "St",
          forest: [
            {
              label: "~Qa,~Pc,Pc:|-:",
              rule: "Ax",
              forest: [{ label: "", rule: "", forest: [] }],
            },
          ],
        },
        {
          label: "Pc,~Qa,Qa:|-:",
          rule: "St",
          forest: [
            {
              label: "Pc,Qa,~Qa:|-:",
              rule: "Ax",
              forest: [{ label: "", rule: "", forest: [] }],
            },
          ],
        },
      ],
    });

    jsonDisplay1.innerHTML =
      "<pre contenteditable='true'>" +
      JSON.stringify(root1, null, 2) +
      "</pre>";
    jsonDisplay2.innerHTML =
      "<pre contenteditable='true'>" +
      JSON.stringify(root2, null, 2) +
      "</pre>";
    jsonDisplay3.innerHTML =
      "<pre contenteditable='true'>" +
      JSON.stringify(root3, null, 2) +
      "</pre>";

    root1.on("changed", function () {
      jsonDisplay1.lastChild.innerHTML =
        "<pre>" + JSON.stringify(root1, null, 2) + "</pre>";
    });

    root2.on("changed", function () {
      jsonDisplay2.lastChild.innerHTML =
        "<pre>" + JSON.stringify(root2, null, 2) + "</pre>";
    });

    root3.on("changed", function () {
      jsonDisplay3.lastChild.innerHTML =
        "<pre>" + JSON.stringify(root3, null, 2) + "</pre>";
    });

    jsonDisplay1.addEventListener("keyup", function () {
      root1.replace(JSON.parse(this.lastChild.innerText));
    });

    jsonDisplay2.addEventListener("keyup", function () {
      root2.replace(JSON.parse(this.lastChild.innerText));
    });

    jsonDisplay3.addEventListener("keyup", function () {
      root3.replace(JSON.parse(this.lastChild.innerText));
    });

    root1.renderOn(sandbox1);
    root2.renderOn(sandbox2);
    root3.renderOn(sandbox3);

    //a proof can be decorated with a tree of annotations
    root1.decorate({
      class: "highlighted",
      info: "an inference the assumption (1)",
      forest: [],
    });

    function trimProof(n, obj) {
      if (n == 0) {
        return { label: obj.label, rule: obj.rule, forest: [] };
      } else {
        return {
          label: obj.label,
          rule: obj.rule,
          forest: obj.forest.map((t) => {
            return trimProof(n - 1, t);
          }),
        };
      }
    }

    function trimInfo(n, obj) {
      if (n == 0) {
        return { info: obj.info, class: obj.class, forest: [] };
      } else {
        return {
          info: obj.info,
          class: obj.class,
          forest: obj.forest.map((t) => {
            return trimInfo(n - 1, t);
          }),
        };
      }
    }

    function slowLoad() {
      setTimeout(function () {
        try {
          Carnap.checkIchikawaJenkinsQLTableau(root1, (t) => {
            root1.decorate(t);
          });
          Carnap.checkIchikawaJenkinsQLTableau(root2, (t) => {
            root2.decorate(t);
          });
          Carnap.checkIchikawaJenkinsQLTableau(root3, (t) => {
            root3.decorate(t);
          });
        } catch (e) {
          slowLoad();
        }
      }, 100);
    }

    slowLoad();

    var updateTimeout;

    root1.on("changed", (thenode) => {
      clearTimeout(updateTimeout);
      updateTimeout = setTimeout(function () {
        Carnap.checkIchikawaJenkinsQLTableau(root1, (t) => {
          root1.decorate(t);
        });
      }, 500);
    });

    root2.on("changed", (thenode) => {
      clearTimeout(updateTimeout);
      updateTimeout = setTimeout(function () {
        if (thenode.label == "") {
          thenode.info = "";
          thenode.class = "";
        }
        if (thenode.parentNode) thenode = thenode.parentNode;
        Carnap.checkIchikawaJenkinsQLTableau(trimProof(2, thenode), (t) => {
          thenode.decorate(trimInfo(1, t));
          console.log(t);
        });
      }, 500);
    });

    root3.on("changed", (thenode) => {
      clearTimeout(updateTimeout);
      updateTimeout = setTimeout(function () {
        if (thenode.label == "") {
          thenode.info = "";
          thenode.class = "";
        }
        if (thenode.parentNode) thenode = thenode.parentNode;
        Carnap.checkIchikawaJenkinsQLTableau(trimProof(2, thenode), (t) => {
          thenode.decorate(trimInfo(1, t));
        });
      }, 500);
    });
  </script>
</html>
